import { useMemo, useState, useEffect } from 'react';
import { BarChart, ChartSeries } from '@components/charts/BarChart';
import { LineChart } from '@components/charts/LineChart';
import { InfoTooltip } from '@components/ui/InfoTooltip';
import { useInvestmentStore } from '@store/investmentStore';
import { usePreciousMetalStore } from '@store/preciousMetalStore';
import { filterRecordsByDateRange } from '@utils/dataFilters';
import { getAccountColors } from '@utils/chartColors';
import {
  calculateMonthlyReturnByAccount,
  getAllUniqueMonthsFromReturnData,
  alignReturnDataToMonths,
  calculateMonthlyProfit
} from '@utils/investmentCalculations';
import { calculateTimeDepositProfitForMonth } from '@utils/timeDepositCalculations';
import { calculateMonthlyAccumulatedProfit } from '@utils/metalCalculations';

interface MonthlyProfitChartProps {
  filterType?: 'all' | 'investment' | 'metal';
  dateRange?: {
    startMonth: string | null;
    endMonth: string | null;
  };
}

type ViewType = 'profit' | 'returnRate';

export const MonthlyProfitChart = ({ filterType = 'all', dateRange }: MonthlyProfitChartProps) => {
  // Derive includeMetal from filterType: include metals in 'all' and 'metal' modes, exclude in 'investment' mode
  const includeMetal = filterType === 'all' || filterType === 'metal';

  const { recordsByType } = useInvestmentStore();
  const { recordsByMetalType } = usePreciousMetalStore();

  // è§†å›¾ç±»å‹çŠ¶æ€ï¼ˆé»˜è®¤æ˜¾ç¤ºæ”¶ç›Šé‡‘é¢ï¼‰
  const [viewType, setViewType] = useState<ViewType>('profit');

  // è´¦æˆ·é€‰æ‹©çŠ¶æ€ï¼ˆnullè¡¨ç¤º"å…¨éƒ¨"æ¨¡å¼ï¼‰
  const [selectedAccounts, setSelectedAccounts] = useState<Set<string> | null>(null);

  // æ•°æ®è®¡ç®—
  const chartData = useMemo(() => {
    // ========== å¤„ç†æ™®é€šæŠ•èµ„æ•°æ® ==========
    if (filterType === 'metal') {
      // è´µé‡‘å±æ¨¡å¼ï¼šä¸æ¶‰åŠè´¦æˆ·ï¼Œè¿”å› null
      return null;
    }

    if (filterType === 'all' || filterType === 'investment') {
      // 1. æ”¶é›†æ‰€æœ‰è®°å½•ï¼ˆä¸åº”ç”¨æ—¥æœŸè¿‡æ»¤ï¼Œåœ¨è®¡ç®—å®Œæˆåå†ç­›é€‰ï¼‰
      const allRecords = Object.values(recordsByType).flat();
      // æ”¶é›†æ‰€æœ‰æœ‰å¿«ç…§çš„è®°å½•ï¼ˆæ’é™¤å®šæœŸå­˜æ¬¾ï¼Œé¿å…é‡å¤è®¡ç®—ï¼‰
      const snapshotRecords = allRecords.filter(r =>
        r.snapshot !== undefined && !r.isTimeDeposit  // æ’é™¤å®šæœŸå­˜æ¬¾
      );

      // 1.5. æ”¶é›†å®šæœŸå­˜æ¬¾è®°å½•
      const timeDepositRecords = allRecords.filter(r =>
        r.isTimeDeposit === true &&
        r.depositTermMonths !== undefined &&
        r.annualInterestRate !== undefined
      );

      if (snapshotRecords.length === 0 && timeDepositRecords.length === 0) {
        return { allData: [], allSeries: [], accountNames: [], isInvestment: true };
      }

      // 2. æŒ‰è´¦æˆ·åˆ†ç»„å¿«ç…§æ•°æ®
      const snapshotsByAccount = new Map<string, Array<{ date: string; snapshot: number }>>();

      snapshotRecords.forEach(record => {
        if (!snapshotsByAccount.has(record.account)) {
          snapshotsByAccount.set(record.account, []);
        }
        snapshotsByAccount.get(record.account)!.push({
          date: record.date,
          snapshot: record.snapshot!
        });
      });

      // 3. å¯¹æ¯ä¸ªè´¦æˆ·çš„å¿«ç…§æŒ‰æ—¥æœŸæ’åº
      snapshotsByAccount.forEach((snapshots) => {
        snapshots.sort((a, b) => a.date.localeCompare(b.date));
      });

      // 4. è®¡ç®—æ¯ä¸ªè´¦æˆ·çš„æœˆåº¦æ”¶ç›Š
      const accountProfits = new Map<string, Map<string, number>>();

      snapshotsByAccount.forEach((snapshots, account) => {
        const profits = new Map<string, number>();

        // éå†æ¯ä¸ªæœˆï¼ˆä»ç¬¬äºŒä¸ªå¿«ç…§å¼€å§‹ï¼Œå› ä¸ºéœ€è¦ä¸Šæœˆå¿«ç…§ï¼‰
        for (let i = 1; i < snapshots.length; i++) {
          const currentSnapshot = snapshots[i];
          const previousSnapshot = snapshots[i - 1];

          // è®¡ç®—å½“æœˆè¯¥è´¦æˆ·çš„æ™®é€šæŠ•èµ„é‡‘é¢ï¼ˆæ’é™¤å®šæœŸå­˜æ¬¾ï¼‰
          // å®šæœŸå­˜æ¬¾çš„æ”¶ç›Šä¼šå•ç‹¬è®¡ç®—å¹¶ç´¯åŠ ï¼Œæ‰€ä»¥è¿™é‡Œä¸åº”è¯¥åŒ…å«å®šæœŸå­˜æ¬¾æœ¬é‡‘
          const currentMonthInvestment = allRecords
            .filter(r => r.account === account && r.date === currentSnapshot.date && !r.isTimeDeposit)
            .reduce((sum, r) => sum + r.amount, 0);

          // æ­£ç¡®å…¬å¼ï¼šå½“æœˆæ”¶ç›Š = (å½“æœˆå¿«ç…§ - ä¸Šæœˆå¿«ç…§) - å½“æœˆæŠ•èµ„é‡‘é¢
          // ä¸æ£€æŸ¥æœˆä»½æ˜¯å¦è¿ç»­ï¼Œä¸æŠ•èµ„è·Ÿè¸ªé¡µé¢ä¿æŒä¸€è‡´
          const profit = (currentSnapshot.snapshot - previousSnapshot.snapshot) - currentMonthInvestment;
          profits.set(currentSnapshot.date, profit);

          // è°ƒè¯•æ—¥å¿—ï¼šéªŒè¯æ”¶ç›Šè®¡ç®—
          if (currentSnapshot.date === '2025-06') {
            console.log(`ğŸ”ã€${account}è´¦æˆ· 2025å¹´6æœˆå¿«ç…§æ”¶ç›Šè®¡ç®—ã€‘`);
            console.log('-----------------------------------');
            console.log(`å½“æœˆå¿«ç…§:   Â¥${currentSnapshot.snapshot.toFixed(2)}`);
            console.log(`ä¸Šæœˆå¿«ç…§:   Â¥${previousSnapshot.snapshot.toFixed(2)}`);
            console.log(`å¿«ç…§å·®å€¼:   Â¥${(currentSnapshot.snapshot - previousSnapshot.snapshot).toFixed(2)}`);
            console.log(`å½“æœˆæ™®é€šæŠ•èµ„: Â¥${currentMonthInvestment.toFixed(2)} (å·²æ’é™¤å®šæœŸå­˜æ¬¾)`);
            console.log(`å¿«ç…§æ”¶ç›Š:   Â¥${profit.toFixed(2)}`);
            console.log('-----------------------------------');
          }
        }

        accountProfits.set(account, profits);
      });

      // 5. æå–æ‰€æœ‰å”¯ä¸€æœˆä»½å¹¶æ’åº
      const allMonths = new Set<string>();
      accountProfits.forEach((profits) => {
        profits.forEach((_, month) => allMonths.add(month));
      });
      const sortedMonths = Array.from(allMonths).sort();

      // 5.5. è®¡ç®—å®šæœŸå­˜æ¬¾çš„æœˆåº¦æ”¶ç›Šï¼ˆæŒ‰è´¦æˆ·åˆ†ç»„ï¼‰
      const timeDepositProfits = new Map<string, number>(); // key: "month|account", value: profit

      if (timeDepositRecords.length > 0) {
        timeDepositRecords.forEach(record => {
          const account = record.account;

          // ä¸ºæ¯ä¸ªæœˆä»½è®¡ç®—å®šæœŸå­˜æ¬¾çš„åˆ©æ¯æ”¶ç›Š
          sortedMonths.forEach(month => {
            const monthlyProfit = calculateTimeDepositProfitForMonth(record, month);

            // æŒ‰è´¦æˆ·å’Œæœˆä»½åˆ†ç»„å­˜å‚¨
            const key = `${month}|${account}`;
            const existingProfit = timeDepositProfits.get(key) || 0;
            timeDepositProfits.set(key, existingProfit + monthlyProfit);
          });
        });
      }

      // 6. è·å–è´¦æˆ·åç§°ï¼ˆåˆå¹¶å¿«ç…§è´¦æˆ·å’Œå®šæœŸå­˜æ¬¾è´¦æˆ·ï¼‰
      const accountNamesFromSnapshots = Array.from(accountProfits.keys());

      // ä»å®šæœŸå­˜æ¬¾åˆ©æ¯ä¸­æå–è´¦æˆ·åç§°
      const accountNamesFromTimeDeposits = new Set<string>();
      timeDepositProfits.forEach((_, key) => {
        // keyæ ¼å¼ï¼š"{month}|{account}"
        const parts = key.split('|');
        if (parts.length === 2) {
          accountNamesFromTimeDeposits.add(parts[1]);
        }
      });

      // åˆå¹¶å¹¶å»é‡
      const accountNames = Array.from(
        new Set([...accountNamesFromSnapshots, ...accountNamesFromTimeDeposits])
      );

      const colorMap = getAccountColors(accountNames);

      // 7. æ„å»ºå›¾è¡¨æ•°æ®ç»“æ„
      const allData = sortedMonths.map(month => {
        const dataPoint: { [key: string]: any } = {
          name: month,
          month
        };

        // ä¸ºæ¯ä¸ªè´¦æˆ·è®¡ç®—æ”¶ç›Šï¼ˆå¿«ç…§å·®å€¼ + å®šæœŸå­˜æ¬¾åˆ©æ¯ï¼‰
        accountNames.forEach(account => {
          const snapshotProfit = accountProfits.get(account)?.get(month) || 0;
          const key = `${month}|${account}`;
          const timeDepositProfit = timeDepositProfits.get(key) || 0;
          dataPoint[account] = snapshotProfit + timeDepositProfit;
        });

        return dataPoint;
      });

      // ã€è°ƒè¯•æ—¥å¿—ã€‘æ‰“å° 2025å¹´6æœˆçš„æœ€ç»ˆæ”¶ç›Šæ±‡æ€»
      const june2025Data = allData.find(d => d.month === '2025-06');
      if (june2025Data) {
        console.log('');
        console.log('ğŸ¯ã€Dashboard 2025å¹´6æœˆæœ€ç»ˆæ”¶ç›Šæ±‡æ€»ã€‘');
        console.log('=====================================');
        let totalProfit = 0;
        let totalSnapshotProfit = 0;
        let totalTimeDepositProfit = 0;

        accountNames.forEach(account => {
          const snapshotProfit = accountProfits.get(account)?.get('2025-06') || 0;
          const key = `2025-06|${account}`;
          const timeDepositProfit = timeDepositProfits.get(key) || 0;
          const total = snapshotProfit + timeDepositProfit;

          totalSnapshotProfit += snapshotProfit;
          totalTimeDepositProfit += timeDepositProfit;
          totalProfit += total;

          if (total !== 0) {
            console.log(`${account}:`);
            console.log(`  - å¿«ç…§æ”¶ç›Š: ${snapshotProfit.toFixed(2)}`);
            console.log(`  - å®šæœŸå­˜æ¬¾åˆ©æ¯: ${timeDepositProfit.toFixed(2)}`);
            console.log(`  - æ€»æ”¶ç›Š: ${total.toFixed(2)}`);
          }
        });
        console.log('-------------------------------------');
        console.log(`å¿«ç…§æ”¶ç›Šæ€»è®¡: ${totalSnapshotProfit.toFixed(2)}`);
        console.log(`å®šæœŸå­˜æ¬¾åˆ©æ¯æ€»è®¡: ${totalTimeDepositProfit.toFixed(2)}`);
        console.log(`æ€»æ”¶ç›Š: ${totalProfit.toFixed(2)}`);
        console.log('=====================================');
        console.log('');
      }

      // ã€è°ƒè¯•æ—¥å¿—ã€‘æ‰“å° 2025å¹´1æœˆçš„æœ€ç»ˆæ”¶ç›Šæ±‡æ€»
      const january2025Data = allData.find(d => d.month === '2025-01');
      if (january2025Data) {
        console.log('');
        console.log('ğŸ¯ã€Dashboard 2025å¹´1æœˆæœ€ç»ˆæ”¶ç›Šæ±‡æ€»ã€‘');
        console.log('=====================================');
        let totalProfit = 0;
        let totalSnapshotProfit = 0;
        let totalTimeDepositProfit = 0;

        accountNames.forEach(account => {
          const snapshotProfit = accountProfits.get(account)?.get('2025-01') || 0;
          const key = `2025-01|${account}`;
          const timeDepositProfit = timeDepositProfits.get(key) || 0;
          const total = snapshotProfit + timeDepositProfit;

          totalSnapshotProfit += snapshotProfit;
          totalTimeDepositProfit += timeDepositProfit;
          totalProfit += total;

          if (total !== 0) {
            console.log(`${account}:`);
            console.log(`  - å¿«ç…§æ”¶ç›Š: ${snapshotProfit.toFixed(2)}`);
            console.log(`  - å®šæœŸå­˜æ¬¾åˆ©æ¯: ${timeDepositProfit.toFixed(2)}`);
            console.log(`  - æ€»æ”¶ç›Š: ${total.toFixed(2)}`);
          }
        });
        console.log('-------------------------------------');
        console.log(`å¿«ç…§æ”¶ç›Šæ€»è®¡: ${totalSnapshotProfit.toFixed(2)}`);
        console.log(`å®šæœŸå­˜æ¬¾åˆ©æ¯æ€»è®¡: ${totalTimeDepositProfit.toFixed(2)}`);
        console.log(`æ€»æ”¶ç›Š: ${totalProfit.toFixed(2)}`);
        console.log('=====================================');
        console.log('');
      }

      // ã€è°ƒè¯•æ—¥å¿—ã€‘æ‰“å°çº³æ–¯è¾¾å…‹è´¦æˆ·æœˆåº¦æ”¶ç›Šç‡è®¡ç®—è¿‡ç¨‹
      if (accountNames.includes('çº³æ–¯è¾¾å…‹')) {
        console.log('');
        console.log('ğŸ“ˆã€çº³æ–¯è¾¾å…‹è´¦æˆ·æœˆåº¦æ”¶ç›Šç‡è®¡ç®—è¿‡ç¨‹ã€‘');
        console.log('=====================================');
        console.log('');

        sortedMonths.forEach(month => {
          // è·å–å½“æœˆå¿«ç…§æ•°æ®
          const snapshots = snapshotsByAccount.get('çº³æ–¯è¾¾å…‹');
          const currentIndex = snapshots?.findIndex(s => s.date === month);

          if (currentIndex !== undefined && currentIndex > 0) {
            const currentSnapshot = snapshots![currentIndex];
            const previousSnapshot = snapshots![currentIndex - 1];

            // è®¡ç®—å¿«ç…§å·®å€¼
            const snapshotDiff = currentSnapshot.snapshot - previousSnapshot.snapshot;

            // è®¡ç®—å½“æœˆæŠ•èµ„é‡‘é¢
            const monthInvestment = allRecords
              .filter(r => r.account === 'çº³æ–¯è¾¾å…‹' && r.date === month)
              .reduce((sum, r) => sum + r.amount, 0);

            // è®¡ç®—å¿«ç…§æ”¶ç›Š
            const snapshotProfit = snapshotDiff - monthInvestment;

            // è®¡ç®—å®šæœŸå­˜æ¬¾åˆ©æ¯
            const key = `${month}|çº³æ–¯è¾¾å…‹`;
            const timeDepositProfit = timeDepositProfits.get(key) || 0;

            // è®¡ç®—æ€»æ”¶ç›Š
            const totalProfit = snapshotProfit + timeDepositProfit;

            // è®¡ç®—æ”¶ç›Šç‡
            const roi = monthInvestment !== 0 ? (totalProfit / monthInvestment) * 100 : 0;

            // æ‰“å°ç®€æ´ç‰ˆè®¡ç®—è¿‡ç¨‹
            console.log(`ğŸ“… æœˆä»½: ${month}`);
            console.log(`-----------------------------------`);
            console.log(`ä¸Šæœˆå¿«ç…§:   Â¥${previousSnapshot.snapshot.toFixed(2)}`);
            console.log(`å½“æœˆå¿«ç…§:   Â¥${currentSnapshot.snapshot.toFixed(2)}`);
            console.log(`å¿«ç…§å·®å€¼:   Â¥${snapshotDiff.toFixed(2)}`);
            console.log(`å½“æœˆæŠ•èµ„:   Â¥${monthInvestment.toFixed(2)}`);
            console.log(`å¿«ç…§æ”¶ç›Š:   Â¥${snapshotProfit.toFixed(2)} (å¿«ç…§å·®å€¼ - å½“æœˆæŠ•èµ„)`);
            console.log(`å®šæœŸåˆ©æ¯:   Â¥${timeDepositProfit.toFixed(2)}`);
            console.log(`å½“æœˆæ€»æ”¶ç›Š: Â¥${totalProfit.toFixed(2)} (å¿«ç…§æ”¶ç›Š + å®šæœŸåˆ©æ¯)`);
            console.log(`æœˆåº¦æ”¶ç›Šç‡: ${roi.toFixed(2)}% (å½“æœˆæ€»æ”¶ç›Š / å½“æœˆæŠ•èµ„ Ã— 100%)`);
            console.log('');
          }
        });

        console.log('=====================================');
        console.log('');
      }

      // 8. æ„å»ºç³»åˆ—é…ç½®
      const allSeries: ChartSeries[] = accountNames.map(account => ({
        dataKey: account,
        name: account,
        color: colorMap.get(account) || '#8b5cf6'
      }));

      // è¾…åŠ©å‡½æ•°ï¼šæŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰å·²è®¡ç®—çš„æ•°æ®
      const filterDataByDateRange = (
        data: Array<{ month: string; [key: string]: number | string }> | undefined
      ) => {
        // å¦‚æœæ•°æ®ä¸ºç©ºæˆ–undefinedï¼Œè¿”å›ç©ºæ•°ç»„
        if (!data || data.length === 0) {
          return [];
        }

        if (!dateRange.startMonth && !dateRange.endMonth) {
          return data; // æ— ç­›é€‰ï¼Œè¿”å›å…¨éƒ¨æ•°æ®
        }

        return data.filter(item => {
          const month = item.month;
          const startCheck = !dateRange.startMonth || month >= dateRange.startMonth;
          const endCheck = !dateRange.endMonth || month <= dateRange.endMonth;
          return startCheck && endCheck;
        });
      };

      // åœ¨è¿”å›å‰åº”ç”¨æ—¥æœŸç­›é€‰
      const filteredAllData = filterDataByDateRange(allData);
      const filteredAllSeries = allSeries.map(series => ({
        ...series,
        data: filterDataByDateRange(series.data)
      }));

      return {
        allData: filteredAllData,
        allSeries: filteredAllSeries,
        accountNames,
        isInvestment: true
      };
    }

    return { allData: [], allSeries: [], accountNames: [], isInvestment: false };
  }, [recordsByType, filterType, dateRange]);

  // æ”¶ç›Šç‡æ•°æ®è®¡ç®—ï¼ˆå¤ç”¨AccountMonthlyReturnChartçš„é€»è¾‘ï¼‰
  const returnRateData = useMemo(() => {
    // è´µé‡‘å±æ¨¡å¼ï¼šä¸æ¶‰åŠæ”¶ç›Šç‡
    if (filterType === 'metal') {
      return null;
    }

    // æ™®é€šæŠ•èµ„æ¨¡å¼ï¼šè®¡ç®—æœˆåº¦æ”¶ç›Šç‡
    if (filterType === 'all' || filterType === 'investment') {
      // è¿‡æ»¤è®°å½•
      const filteredRecordsByType: { [key: string]: any[] } = {};
      Object.entries(recordsByType).forEach(([type, records]) => {
        filteredRecordsByType[type] = filterRecordsByDateRange(
          records,
          dateRange || { startMonth: null, endMonth: null }
        );
      });

      // è®¡ç®—æ¯ä¸ªè´¦æˆ·çš„æœˆåº¦æ”¶ç›Šç‡
      const returnDataByAccount = calculateMonthlyReturnByAccount(filteredRecordsByType);

      // å¦‚æœæ²¡æœ‰è´¦æˆ·æ•°æ®
      if (returnDataByAccount.length === 0) {
        return { series: [], data: [], accountNames: [], allData: null, colorMap: null };
      }

      // è·å–æ‰€æœ‰å”¯ä¸€æœˆä»½
      let allMonths = getAllUniqueMonthsFromReturnData(returnDataByAccount);

      // åº”ç”¨æ—¥æœŸèŒƒå›´è¿‡æ»¤åˆ°æœˆä»½
      allMonths = allMonths.filter(month => {
        if (dateRange?.startMonth && month < dateRange.startMonth) return false;
        if (dateRange?.endMonth && month > dateRange.endMonth) return false;
        return true;
      });

      // è·å–è´¦æˆ·é¢œè‰²
      const accountNames = returnDataByAccount.map(d => d.account);
      const colorMap = getAccountColors(accountNames);

      // å¯¹é½æ¯ä¸ªè´¦æˆ·çš„æ•°æ®åˆ°ç»Ÿä¸€çš„æœˆä»½è½´
      const alignedData = returnDataByAccount.map(({ account, data }) => ({
        account,
        alignedReturn: alignReturnDataToMonths(data, allMonths)
      }));

      // æ„å»ºå®Œæ•´çš„å›¾è¡¨æ•°æ®ç»“æ„ï¼ˆå¤šçº¿æ ¼å¼ï¼‰
      const allChartDataPoints = allMonths.map((month, monthIndex) => {
        const dataPoint: { [key: string]: any } = {
          name: month,
          month
        };

        alignedData.forEach(({ account, alignedReturn }) => {
          dataPoint[account] = alignedReturn[monthIndex]?.returnRate ?? null;
        });

        return dataPoint;
      });

      // æ„å»ºç³»åˆ—é…ç½®
      const allSeries: ChartSeries[] = alignedData.map(({ account }) => ({
        dataKey: account,
        name: account,
        color: colorMap.get(account) || '#8b5cf6'
      }));

      return {
        allSeries,
        allData: allChartDataPoints,
        accountNames: alignedData.map(d => d.account),
        colorMap
      };
    }

    return { series: [], data: [], accountNames: [], allData: null, colorMap: null };
  }, [recordsByType, filterType, dateRange]);

  // ========== å¤„ç†è´µé‡‘å±æŠ•èµ„æ•°æ®ï¼ˆå•ç³»åˆ—æ¨¡å¼ï¼‰==========
  const metalChartData = useMemo(() => {
    if (filterType === 'all' || filterType === 'metal') {
      // æ”¶é›†æ‰€æœ‰è®°å½•ï¼ˆä¸åº”ç”¨æ—¥æœŸè¿‡æ»¤ï¼Œåœ¨è®¡ç®—å®Œæˆåå†ç­›é€‰ï¼‰
      const allMetalRecords = Object.values(recordsByMetalType).flat();

      if (allMetalRecords.length === 0) {
        return [];
      }

      const uniqueMonths = new Set(allMetalRecords.map(r => r.date));
      const sortedMonths = Array.from(uniqueMonths).sort((a, b) => a.localeCompare(b));

      // âœ… æ— è®º 'all' è¿˜æ˜¯ 'metal'ï¼Œéƒ½è®¡ç®—å¹¶è¿”å›è´µé‡‘å±æ”¶ç›Šæ•°æ®
      // å…ˆè®¡ç®—æ‰€æœ‰æœˆåº¦æ”¶ç›Š
      const allMetalData = sortedMonths.map((month) => {
        // æŒ‰è´µé‡‘å±ç±»å‹åˆ†ç»„è®°å½•
        const recordsByType: { [metalType: string]: typeof allMetalRecords } = {};
        allMetalRecords.forEach(record => {
          if (!recordsByType[record.metalType]) {
            recordsByType[record.metalType] = [];
          }
          recordsByType[record.metalType].push(record);
        });

        // è´µé‡‘å±æœˆå‡æ”¶ç›Š = å½“æœˆå‡ä»·Ã—å½“æœˆç´¯è®¡è´­ä¹°å…‹æ•°-ä¸Šæœˆå‡ä»·Ã—ä¸Šæœˆç´¯è®¡è´­ä¹°å…‹æ•°-å½“æœˆæŠ•èµ„é‡‘é¢
        // ä½¿ç”¨ç»Ÿä¸€çš„è®¡ç®—å‡½æ•°
        const monthlyProfits = calculateMonthlyAccumulatedProfit(recordsByType, month);

        // è®¡ç®—æ‰€æœ‰è´µé‡‘å±çš„å•æœˆæ”¶ç›Šæ€»å’Œ
        const totalProfit = Object.values(monthlyProfits).reduce((sum, profit) => sum + profit, 0);

        return {
          label: month,
          value: totalProfit
        };
      });

      // è¾…åŠ©å‡½æ•°ï¼šæŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰è´µé‡‘å±æ•°æ®
      const filterMetalDataByDateRange = (
        data: Array<{ label: string; value: number }>
      ) => {
        if (!data || data.length === 0) {
          return [];
        }

        if (!dateRange.startMonth && !dateRange.endMonth) {
          return data; // æ— ç­›é€‰ï¼Œè¿”å›å…¨éƒ¨æ•°æ®
        }

        return data.filter(item => {
          const month = item.label;
          const startCheck = !dateRange.startMonth || month >= dateRange.startMonth;
          const endCheck = !dateRange.endMonth || month <= dateRange.endMonth;
          return startCheck && endCheck;
        });
      };

      // åœ¨è¿”å›å‰åº”ç”¨æ—¥æœŸç­›é€‰
      return filterMetalDataByDateRange(allMetalData);
    }

    return [];
  }, [recordsByMetalType, filterType, dateRange]);

  // åˆå§‹åŒ–é€‰ä¸­è´¦æˆ·ï¼ˆæ ¹æ®è§†å›¾ç±»å‹è®¾ç½®é»˜è®¤å€¼ï¼‰
  useEffect(() => {
    if (viewType === 'profit' && chartData?.accountNames && chartData.accountNames.length > 0) {
      // æ”¶ç›Šé‡‘é¢è§†å›¾ï¼šé»˜è®¤ä¸ºnullï¼ˆæ˜¾ç¤ºå…¨éƒ¨è´¦æˆ·æ€»æ”¶ç›Šï¼‰
      setSelectedAccounts(null);
    } else if (viewType === 'returnRate' && returnRateData?.accountNames && returnRateData.accountNames.length > 0) {
      // æ”¶ç›Šç‡è§†å›¾ï¼šé»˜è®¤é€‰ä¸­æ‰€æœ‰è´¦æˆ·
      setSelectedAccounts(new Set(returnRateData.accountNames));
    }
  }, [viewType, chartData?.accountNames, returnRateData?.accountNames]);

  // æ ¹æ®è§†å›¾ç±»å‹å’Œè´¦æˆ·é€‰æ‹©è¿‡æ»¤æ•°æ®
  const filteredChartData = useMemo(() => {
    // æ”¶ç›Šé‡‘é¢è§†å›¾
    if (viewType === 'profit') {
      if (!chartData || !chartData.allData || chartData.allData.length === 0) {
        return { series: null, data: [] };
      }

      // å¦‚æœ selectedAccounts ä¸º nullï¼Œè¡¨ç¤º"å…¨éƒ¨"æ¨¡å¼ï¼Œæ˜¾ç¤ºæ‰€æœ‰è´¦æˆ·çš„æ€»æ”¶ç›Šï¼ˆå•ç³»åˆ—æ¨¡å¼ï¼‰
      if (selectedAccounts === null) {
        const aggregatedData = chartData.allData.map(monthData => {
          // 1. æ±‡æ€»æ‰€æœ‰è´¦æˆ·çš„æ”¶ç›Šï¼ˆå·²åŒ…æ‹¬è¯¥è´¦æˆ·çš„å®šæœŸå­˜æ¬¾ï¼‰
          const totalProfit = chartData.accountNames.reduce((sum, account) => {
            return sum + (monthData[account] || 0);
          }, 0);

          // 2. åŠ ä¸Šè´µé‡‘å±æ”¶ç›Šï¼ˆfilterType='all' ä¸” includeMetal=true æ—¶ï¼‰
          let metalProfit = 0;
          if (filterType === 'all' && includeMetal && metalChartData.length > 0) {
            // ä»metalChartDataä¸­æ‰¾åˆ°å¯¹åº”æœˆä»½çš„è´µé‡‘å±æ”¶ç›Š
            const metalData = metalChartData.find(d => d.label === monthData.month);
            if (metalData) {
              metalProfit = metalData.value;
            }
          }

          const finalTotal = totalProfit + metalProfit;

          return {
            label: monthData.month,
            value: finalTotal
          };
        });

        return { series: null, data: aggregatedData, mode: 'all' as const };
      }

      // æœ‰é€‰ä¸­è´¦æˆ·ï¼šæ˜¾ç¤ºåˆ†ç»„æŸ±çŠ¶å›¾ï¼ˆå¤šç³»åˆ—æ¨¡å¼ï¼‰
      const filteredSeries = chartData.allSeries.filter(s =>
        selectedAccounts.has(s.name)
      );

      const filteredData = chartData.allData.map(monthData => {
        const dataPoint: { [key: string]: any } = {
          name: monthData.month
        };

        filteredSeries.forEach(series => {
          // ã€ä¿®æ”¹ã€‘ç›´æ¥ä½¿ç”¨è´¦æˆ·çš„æ”¶ç›Šï¼ˆå·²åŒ…æ‹¬è¯¥è´¦æˆ·çš„å®šæœŸå­˜æ¬¾ï¼‰
          dataPoint[series.dataKey] = monthData[series.dataKey] || 0;
        });

        return dataPoint;
      });

      return {
        series: filteredSeries,
        data: filteredData,
        selectedCount: selectedAccounts.size,
        totalCount: chartData.accountNames.length,
        mode: 'filtered' as const
      };
    }

    // æ”¶ç›Šç‡è§†å›¾
    if (viewType === 'returnRate') {
      if (!returnRateData || !returnRateData.allData || !returnRateData.allSeries) {
        return { series: [], data: [] };
      }

      // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•è´¦æˆ·ï¼Œæ˜¾ç¤ºæ‰€æœ‰è´¦æˆ·
      const accountsToShow = selectedAccounts && selectedAccounts.size > 0
        ? selectedAccounts
        : new Set(returnRateData.accountNames);

      // è¿‡æ»¤ç³»åˆ—é…ç½®
      const filteredSeries = returnRateData.allSeries.filter(s =>
        accountsToShow.has(s.name)
      );

      // è¿‡æ»¤æ•°æ®ç‚¹
      const filteredData = returnRateData.allData.map(dataPoint => {
        const filteredPoint: { [key: string]: any } = {
          name: dataPoint.name,
          month: dataPoint.month
        };

        filteredSeries.forEach(series => {
          filteredPoint[series.dataKey] = dataPoint[series.dataKey];
        });

        return filteredPoint;
      });

      return {
        series: filteredSeries,
        data: filteredData,
        selectedCount: accountsToShow.size,
        totalCount: returnRateData.accountNames.length
      };
    }

    return { series: [], data: [] };
  }, [viewType, chartData, returnRateData, selectedAccounts, metalChartData, filterType, includeMetal]);

  // ========== æ¸²æŸ“é€»è¾‘ ==========
  // è´µé‡‘å±æ¨¡å¼æˆ–æ··åˆæ¨¡å¼ï¼ˆæœ‰è´µé‡‘å±æ•°æ®ï¼‰
  if ((filterType === 'metal' || (filterType === 'all' && metalChartData.length > 0)) &&
      (!chartData || !chartData.isInvestment)) {
    return (
      <div className="bg-white rounded-xl p-4 shadow-lg">
        {metalChartData.length > 0 ? (
          <BarChart
            data={metalChartData}
            height={280}
            title={
              <>
                ğŸ“ˆ æœˆåº¦æŠ•èµ„æ”¶ç›Š
                <InfoTooltip content="æœˆå‡æ”¶ç›Š = å½“æœˆå‡ä»·Ã—å½“æœˆç´¯è®¡è´­ä¹°å…‹æ•°-ä¸Šæœˆå‡ä»·Ã—ä¸Šæœˆç´¯è®¡è´­ä¹°å…‹æ•°-å½“æœˆæŠ•èµ„é‡‘é¢" />
              </>
            }
            yLabel="æ”¶ç›Šé‡‘é¢ (Â¥)"
            xLabel="æœˆä»½"
          />
        ) : (
          <div className="text-center py-12 text-gray-500">
            æš‚æ— è´µé‡‘å±æ•°æ®ï¼Œè¯·æ·»åŠ è´µé‡‘å±æŠ•èµ„è®°å½•
          </div>
        )}
      </div>
    );
  }

  // æ™®é€šæŠ•èµ„æ¨¡å¼
  if (!chartData || !chartData.allData || chartData.allData.length === 0) {
    return (
      <div className="bg-white rounded-xl p-4 shadow-lg">
        <div className="text-center py-12 text-gray-500">
          æš‚æ— å¿«ç…§æ•°æ®ï¼Œè¯·æ·»åŠ å¸¦æœ‰å¿«ç…§é‡‘é¢çš„æŠ•èµ„è®°å½•
        </div>
      </div>
    );
  }

  // å¤„ç†è´¦æˆ·é€‰æ‹©
  const handleAccountToggle = (accountName: string) => {
    setSelectedAccounts(prev => {
      // å¦‚æœå½“å‰æ˜¯"å…¨éƒ¨"æ¨¡å¼ï¼Œåˆ‡æ¢åˆ°é€‰ä¸­è¯¥è´¦æˆ·
      if (prev === null) {
        return new Set([accountName]);
      }

      // å¦åˆ™æ­£å¸¸åˆ‡æ¢
      const newSet = new Set(prev);
      if (newSet.has(accountName)) {
        // å¦‚æœåªå‰©1ä¸ªé€‰ä¸­ï¼Œå–æ¶ˆæ—¶åˆ‡æ¢å›"å…¨éƒ¨"æ¨¡å¼
        if (newSet.size > 1) {
          newSet.delete(accountName);
        } else {
          return null;  // è¿”å›"å…¨éƒ¨"æ¨¡å¼
        }
      } else {
        newSet.add(accountName);
      }
      return newSet;
    });
  };

  // ç‚¹å‡»"å…¨éƒ¨"æŒ‰é’®ï¼Œåˆ‡æ¢åˆ°"å…¨éƒ¨"æ¨¡å¼
  const handleShowAll = () => {
    setSelectedAccounts(null);
  };

  // æ¸²æŸ“æ™®é€šæŠ•èµ„å›¾è¡¨
  return (
    <div className="bg-white rounded-xl p-4 shadow-lg">
      {/* è§†å›¾ç±»å‹é€‰æ‹©å™¨ */}
      <div className="mb-4">
        <label className="block text-sm font-medium text-gray-700 mb-2">
          æ˜¾ç¤ºå†…å®¹ï¼š
        </label>
        <select
          value={viewType}
          onChange={(e) => setViewType(e.target.value as ViewType)}
          className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        >
          <option value="profit">æ”¶ç›Šé‡‘é¢</option>
          <option value="returnRate">æ”¶ç›Šç‡</option>
        </select>
      </div>

      {/* è´¦æˆ·é€‰æ‹©å™¨ */}
      {((viewType === 'profit' && chartData?.accountNames && chartData.accountNames.length > 1) ||
        (viewType === 'returnRate' && returnRateData?.accountNames && returnRateData.accountNames.length > 1)) && (
        <div className="mb-4">
          <div className="flex items-center gap-2 mb-2">
            <span className="text-sm font-medium text-gray-700">é€‰æ‹©è´¦æˆ·æ˜¾ç¤ºï¼š</span>
            {/* "å…¨éƒ¨"æŒ‰é’® - ä»…åœ¨æ”¶ç›Šé‡‘é¢è§†å›¾æ˜¾ç¤º */}
            {viewType === 'profit' && (
              <button
                onClick={handleShowAll}
                className={`
                  px-3 py-1.5 rounded-full text-xs font-medium transition-all
                  ${selectedAccounts === null
                    ? 'bg-indigo-600 text-white shadow-sm'
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }
                `}
              >
                å…¨éƒ¨
                {selectedAccounts === null && <span className="ml-1">âœ“</span>}
              </button>
            )}
          </div>
          {/* è´¦æˆ·æŒ‰é’®åˆ—è¡¨ */}
          <div className="flex flex-wrap gap-2">
            {(viewType === 'profit' ? chartData.allSeries : returnRateData?.allSeries)?.map((series) => {
              const isSelected = selectedAccounts !== null && selectedAccounts.has(series.name);
              return (
                <button
                  key={series.name}
                  onClick={() => handleAccountToggle(series.name)}
                  className={`
                    px-3 py-1.5 rounded-full text-xs font-medium transition-all
                    ${isSelected
                      ? 'text-white shadow-sm'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }
                  `}
                  style={{
                    backgroundColor: isSelected ? series.color : undefined,
                    opacity: isSelected ? 1 : 0.6
                  }}
                  title={series.name}
                >
                  {series.name}
                  {isSelected && (
                    <span className="ml-1">âœ“</span>
                  )}
                </button>
              );
            })}
          </div>
          {/* çŠ¶æ€æç¤º */}
          <div className="mt-2 text-xs text-gray-500">
            {viewType === 'profit' ? (
              selectedAccounts === null
                ? 'æ˜¾ç¤ºå…¨éƒ¨è´¦æˆ·æ€»æ”¶ç›Š'
                : selectedAccounts.size === chartData.accountNames.length
                ? 'å·²é€‰æ‹©æ‰€æœ‰è´¦æˆ·'
                : `å·²é€‰æ‹© ${filteredChartData.selectedCount} / ${filteredChartData.totalCount} ä¸ªè´¦æˆ·`
            ) : (
              `å·²é€‰æ‹© ${filteredChartData.selectedCount} / ${filteredChartData.totalCount} ä¸ªè´¦æˆ·`
            )}
          </div>
        </div>
      )}

      {/* å›¾è¡¨ - æ ¹æ®è§†å›¾ç±»å‹æ¸²æŸ“ */}
      {viewType === 'profit' ? (
        <BarChart
          data={filteredChartData.data}
          series={filteredChartData.series || undefined}
          height={280}
          title={
            <span className="flex items-center justify-center">
              ğŸ“ˆ æœˆåº¦æŠ•èµ„æ”¶ç›Š
              <InfoTooltip
                content={[
                  'ã€æ”¶ç›Šé‡‘é¢è®¡ç®—å…¬å¼ã€‘',
                  'å½“æœˆæ”¶ç›Š = å½“å‰èµ„äº§ - ä¸Šæœˆèµ„äº§ - å½“æœˆæŠ•èµ„é‡‘é¢',
                  '',
                  'è¯´æ˜ï¼š',
                  'â€¢ å½“å‰èµ„äº§ï¼šå½“æœˆå¿«ç…§é‡‘é¢ï¼ˆæ™®é€šæŠ•èµ„ï¼‰+ å®é™…ç´¯è®¡åˆ©æ¯ï¼ˆå®šæœŸå­˜æ¬¾ï¼‰',
                  'â€¢ ä¸Šæœˆèµ„äº§ï¼šä¸Šæœˆå¿«ç…§é‡‘é¢ï¼ˆæ™®é€šæŠ•èµ„ï¼‰+ å®é™…ç´¯è®¡åˆ©æ¯ï¼ˆå®šæœŸå­˜æ¬¾ï¼‰',
                  'â€¢ å®šæœŸå­˜æ¬¾åˆ©æ¯ï¼šæŒ‰æœˆç²¾ç¡®è®¡ç®—ï¼Œä¸ä½¿ç”¨å¹³å‡å€¼',
                  'â€¢ åˆå§‹æŠ•èµ„å½“æœˆï¼ˆè´¦æˆ·ç¬¬ä¸€ä¸ªæœˆï¼‰çš„æ”¶ç›Šä¸º0'
                ]}
              />
            </span>
          }
          yLabel="æ”¶ç›Šé‡‘é¢ (Â¥)"
          xLabel="æœˆä»½"
        />
      ) : (
        <LineChart
          data={filteredChartData.data}
          series={filteredChartData.series || undefined}
          height={280}
          title={
            <span className="flex items-center justify-center">
              ğŸ“ˆ è´¦æˆ·æœˆåº¦æ”¶ç›Šç‡
              <InfoTooltip
                content={[
                  'ã€æœˆåº¦æ”¶ç›Šç‡è®¡ç®—å…¬å¼ã€‘',
                  'æ”¶ç›Šç‡ = (å½“æœˆæ”¶ç›Š / ä¸Šæœˆå¿«ç…§) Ã— 100%',
                  '',
                  'è¯´æ˜ï¼š',
                  'â€¢ ä¸Šæœˆå¿«ç…§ä½œä¸ºåŸºå‡†èµ„äº§',
                  'â€¢ æ”¶ç›Šç‡åæ˜ æŠ•èµ„æ•ˆç‡',
                  'â€¢ åªè®¡ç®—è¿ç»­æœˆä»½çš„æ•°æ®'
                ]}
              />
            </span>
          }
          yLabel="æ”¶ç›Šç‡ (%)"
          xLabel="æœˆä»½"
          yAxisFormatter={(value) => `${value.toFixed(1)}%`}
          tooltipFormatter={(value, name) => [
            `æ”¶ç›Šç‡: ${(value ?? 0).toFixed(2)}%`,
            name || ''
          ]}
        />
      )}
    </div>
  );
};
